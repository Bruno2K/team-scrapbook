generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum Team {
  RED
  BLU
}

enum TF2Class {
  Scout
  Soldier
  Pyro
  Demoman
  Heavy
  Engineer
  Medic
  Sniper
  Spy
}

enum FeedType {
  post
  achievement
  community
  scrap
}

enum ScrapReaction {
  headshot
  heal
  burn
  backstab
}

model User {
  id              String         @id @default(cuid())
  name            String
  nickname        String         @unique
  passwordHash    String
  team            Team           @default(RED)
  mainClass       TF2Class       @default(Scout)
  level           Int            @default(1)
  avatar          String?
  online          Boolean        @default(false)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  feedItems       FeedItem[]
  scrapsSent      ScrapMessage[] @relation("ScrapsSent")
  scrapsReceived  ScrapMessage[] @relation("ScrapsReceived")
  friendshipsAs1  Friendship[]   @relation("FriendshipUser1")
  friendshipsAs2  Friendship[]   @relation("FriendshipUser2")
  blockedUsers    BlockedUser[]     @relation("BlockedUserBlocker")
  blockedBy       BlockedUser[]     @relation("BlockedUserBlocked")
  communityMembers CommunityMember[]
  communitiesOwned  Community[]         @relation("CommunityOwner")
  postComments    PostComment[]
  feedItemReactions FeedItemReaction[]
  commentReactions  CommentReaction[]
  scrapMessageReactions ScrapMessageReaction[]
}

model Friendship {
  id       String @id @default(cuid())
  user1Id  String
  user2Id  String
  user1    User   @relation("FriendshipUser1", fields: [user1Id], references: [id], onDelete: Cascade)
  user2    User   @relation("FriendshipUser2", fields: [user2Id], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())
  @@unique([user1Id, user2Id])
}

model BlockedUser {
  id         String   @id @default(cuid())
  blockerId  String
  blockedId  String
  blocker    User     @relation("BlockedUserBlocker", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked    User     @relation("BlockedUserBlocked", fields: [blockedId], references: [id], onDelete: Cascade)
  createdAt  DateTime @default(now())
  @@unique([blockerId, blockedId])
}

model FeedItem {
  id             String    @id @default(cuid())
  userId         String
  user           User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  content        String
  type           FeedType  @default(post)
  communityId    String?
  community      Community? @relation(fields: [communityId], references: [id], onDelete: Cascade)
  allowComments  Boolean   @default(true)
  allowReactions Boolean   @default(true)
  createdAt      DateTime  @default(now())
  comments       PostComment[]
  reactions      FeedItemReaction[]
}

model PostComment {
  id         String        @id @default(cuid())
  feedItemId String?
  feedItem   FeedItem?     @relation(fields: [feedItemId], references: [id], onDelete: Cascade)
  scrapId    String?
  scrap      ScrapMessage? @relation(fields: [scrapId], references: [id], onDelete: Cascade)
  parentId   String?
  parent     PostComment?  @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    PostComment[] @relation("CommentReplies")
  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  content    String
  createdAt  DateTime      @default(now())
  reactions  CommentReaction[]
}

model FeedItemReaction {
  id         String        @id @default(cuid())
  feedItemId String
  feedItem   FeedItem      @relation(fields: [feedItemId], references: [id], onDelete: Cascade)
  userId     String
  user       User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reaction   ScrapReaction
  createdAt  DateTime      @default(now())
  @@unique([feedItemId, userId])
}

model CommentReaction {
  id        String       @id @default(cuid())
  commentId String
  comment   PostComment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  reaction  ScrapReaction
  createdAt DateTime     @default(now())
  @@unique([commentId, userId])
}

model ScrapMessage {
  id        String        @id @default(cuid())
  fromUserId String
  from       User          @relation("ScrapsSent", fields: [fromUserId], references: [id], onDelete: Cascade)
  toUserId   String
  to         User          @relation("ScrapsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  content    String
  reaction   ScrapReaction?
  createdAt  DateTime      @default(now())
  scrapReactions ScrapMessageReaction[]
  comments   PostComment[]
}

model ScrapMessageReaction {
  id        String        @id @default(cuid())
  scrapId   String
  scrap     ScrapMessage  @relation(fields: [scrapId], references: [id], onDelete: Cascade)
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  reaction  ScrapReaction
  createdAt DateTime      @default(now())
  @@unique([scrapId, userId])
}

enum CommunityMemberRole {
  MEMBER
  ADMIN
}

model Community {
  id            String           @id @default(cuid())
  name          String
  description   String
  memberCount   Int              @default(0)
  dominantClass TF2Class?
  team          Team?
  ownerId       String?
  owner         User?            @relation("CommunityOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  createdAt     DateTime        @default(now())
  members       CommunityMember[]
  feedItems     FeedItem[]
}

model CommunityMember {
  id          String              @id @default(cuid())
  userId      String
  communityId String
  role        CommunityMemberRole @default(MEMBER)
  user        User                @relation(fields: [userId], references: [id], onDelete: Cascade)
  community   Community           @relation(fields: [communityId], references: [id], onDelete: Cascade)
  joinedAt    DateTime            @default(now())
  @@unique([userId, communityId])
}
